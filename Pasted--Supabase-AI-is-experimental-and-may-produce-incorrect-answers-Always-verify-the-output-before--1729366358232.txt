-- Supabase AI is experimental and may produce incorrect answers
-- Always verify the output before executing

-- Create extension for vector type
create extension if not exists vector;

-- Create table for users
create table
  users (
    id bigint primary key generated always as identity,
    username text not null unique,
    created_at timestamp with time zone default current_timestamp,
    updated_at timestamp with time zone default current_timestamp
  );

-- Create table for user chat history
create table
  user_chat_history (
    id bigint primary key generated always as identity,
    user_id bigint not null,
    message text not null,
    chat_type text default 'text', -- Optional field to specify type of chat
    "TIMESTAMP" timestamp with time zone default current_timestamp,
    last_updated timestamp with time zone default current_timestamp,
    deleted_at timestamp with time zone, -- Soft delete
    vector vector (384), -- Optional: for embeddings
    foreign key (user_id) references users (id) on delete cascade,
    check (length(message) > 0) -- Ensure message is not empty
  );

create index user_chat_history_user_id_idx on user_chat_history (user_id);

-- Create table for video analysis output
create table
  video_analysis_output (
    id bigint primary key generated always as identity,
    user_id bigint not null,
    upload_file_name text not null,
    analysis text not null,
    video_duration text, -- Optional field for video duration
    video_format text, -- Optional field for video format
    "TIMESTAMP" timestamp with time zone default current_timestamp,
    last_updated timestamp with time zone default current_timestamp,
    deleted_at timestamp with time zone, -- Soft delete
    vector vector (384), -- Optional: for embeddings
    foreign key (user_id) references users (id) on delete cascade,
    check (length(upload_file_name) > 0) -- Ensure file name is not empty
  );

create index video_analysis_output_user_id_idx on video_analysis_output (user_id);